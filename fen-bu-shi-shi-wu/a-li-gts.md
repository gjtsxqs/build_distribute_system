## GTS的技术路线 {#11}

GTS采用基于XA架构优化的技术路线，在保留XA架构灵活性的优点下，通过将XA提交中的第一阶段与第二阶段解耦，将提交过程转换为第一阶段本地事务提交+第二阶段异步清理的方式，从而提供提升系统性能，同时通过在GTS内部维护应用级别的日志与锁信息，实现了全局事务的回滚与并发控制。

GTS方案认为XA性能低效的根本原因是采用了阻塞协议。在分布式事务提交的第一阶段等待最慢的一个事务分支完成，即使在不存在锁冲突的情况下，各事务分支的数据库连接依然会被挂起所占用的资源都不能够释放，以防止全局事务提交前释放资源所造成的数据不一致。对于业务流量极高的大规模互联网企业，难以接受 XA 两阶段提交协议所带来的巨大性能开销。

GTS架构包含的组件与XA完全相同，示意架构如下图。

![](/assets/import31.png)

GTS全局事务处理流程与XA一致，也包括全局事务注册、数据访问与全局事务提交三个步骤，但在第二步与第三步的内部处理上与XA不同：

* 第二步数据访问中，各事务分支完成数据操作的同时，会将全局事务信息（锁与日志信息）存储在当前数据库的表中。
* 第三步全局事务提交中，采用一阶段本地事务提交+二阶段异步清理的方式。首先对各数据库做本地事务的提交，并释放数据库连接等系统资源，然后，向TM发出全局事务提交请求，TM收到请求后，立即返回成功，TM后续实际工作是对各个数据库使用全局事务标识符进行全局事务信息的清理。

GTS与XA在全局事务的故障恢复处理与并发控制采用了不同的实现机制：

* XA两阶段协议是基于数据库内核的日志与锁信息实现全局事务的回滚与并发控制。由于GTS一阶段本地事务提交中，会直接提交本地事务并释放连接，此时数据库内核的日志与锁表对全局事务不再有效。在第二步中，GTS会将日志和锁信息存储在表中，当事务本地提交后，日志和锁信息被持久化保存，用于实现全局事务的并发控制与故障恢复。
* GTS的故障恢复只有UNDO操作没有REDO操作，日志表中存储了UNDO需要的信息，包括行记录标识、全局事务号、镜像查询语句、操作的前像与操作的后像。当发生故障时，对于已经本地提交的数据库，从UNDO表中找到修改的记录，记录的操作前像和操作后像，使用镜像查询语句从数据库中读取该记录的当前值。如果当前值与记录操作后像相同，则直接使用操作前像进行恢复，否则报警，进行人工处理。
* GTS的全局锁表中存储了记录的加锁信息。封锁的粒度是行（记录），锁的类型包括共享锁和互斥锁，对于同一个记录，加锁的规则是共享锁与共享锁不冲突，共享锁与互斥锁冲突、互斥锁与互斥锁冲突。对插入\(INSERT\)、修改\(UPDATE\)、删除\(DELETE\)、更新模式的锁定查询\(SELECT… FOR UPDATE\) 操作加互斥锁。对于共享模式的锁定查询 \(SELECT…LOCK IN SHARE MODE\) 操作加共享锁。若没有锁冲突，在GTS锁表中，增加一行记录，表示加锁成功。
* GTS的默认隔离级别为读未提交（脏数据），使用SELECT… FOR UPDATE和SELECT…LOCK IN SHARE MODE，可使查询隔离级别提升至读已提交。

## 三、GTS的架构与处理流程 {#12}

### 架构 {#13}

下图描述了GTS一种可能的实现架构

![](/assets/import01.png)

与XA架构相同，GTS架构由应用、事务管理器、资源管理器三个部分组成。资源管理器由事务分支处理模块、镜像查询构造模块、并发控制模块、恢复控制模块，以及存储在数据库中的GTS事务信息（GTS锁表与GTS日志表）等组成。

* 事务分支处理模块：是资源管理器的外部接口，并完成内部各模块的调用。
* 镜像查询构造模块：从Insert、Update、Delete语句，生成该操作对应记录集的镜像查询语句。例如table\_name表包含两个字段column1和column2，column1为主键，则镜像查询语句为select column1, column2 from table\_name where column1=v1。
* 并发控制模块：基于GTS事务锁表，维护读写并发控制。锁表定义如下：

|  |
| :--- |


| 字段名 | 字段类型 | 字段描述 |
| :--- | :--- | :--- |
| ID | 整数 | 自增主键 |
| TABLE\_NAME | 字符串 | 表名 |
| KEY\_VALUE | 整数 | 数据行ID |
| XID | 字符串 | 全局事务标识 |
| XLOCK | 整数 | 互斥锁标记 |
| SLOCK | 整数 | 共享锁标记 |
| BRANCH\_ID | 整数 | 事务分支标识 |

恢复控制模块：基于GTS日志表，进行故障恢复。 日志表定义如下：

| 字段名 | 字段类型 | 字段描述 |
| :--- | :--- | :--- |
| ID | 整数 | 自增主键 |
| GMT\_CREATE | 时间 | 创建时间 |
| GMT\_MODIFIED | datetime | 修改时间 |
| XID | 整数 | 全局事务ID |
| BRANCH\_ID | 整数 | 分支事务ID |
| ROLLBACK\_INFO | longblob | 查询语句、前像与后像 |
| STATUS | 整数 | 状态 |
| SERVER | 字符串 | 分支所在DB IP |



### 主要流程序列图 {#14}

分别描述了insert/delete/update操作、读已提交操作、提交操作和回滚操作等四个操作的序列图（一种可能的实现方式）。

#### insert/delete/update操作流程序列图 {#15}



![](https://raw.githubusercontent.com/ChengXiaoZ/docs/master/media/2018-01-01-SEQ-INSERT-DEL-UPDATE.png "2018-01-01-SEQ-INSERT-DEL-UPDATE.png")

#### 读已提交操作流程序列图 {#16}



![](https://raw.githubusercontent.com/ChengXiaoZ/docs/master/media/2018-01-01-SEQ-READ-COMMIT.png "2018-01-01-SEQ-READ-COMMIT.png")

#### 提交操作流程序列图 {#17}



![](https://raw.githubusercontent.com/ChengXiaoZ/docs/master/media/2018-01-01-SEQ-COMMIT.png "2018-01-01-SEQ-COMMIT.png")

#### 回滚操作流程序列图 {#18}



![](https://raw.githubusercontent.com/ChengXiaoZ/docs/master/media/2018-01-01-SEQ-ROLLBACK.png "2018-01-01-SEQ-ROLLBACK.png")





